<div class="max-w-7xl mx-auto mb-6">
  <h2 class="text-2xl font-semibold text-blue-700">Add New Laboratory Test</h2>

  <!-- Success or Error Message Display -->
  <div *ngIf="successMessage" class="bg-green-200 text-green-800 p-2 mt-4 rounded-md">
    {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="bg-red-200 text-red-800 p-2 mt-4 rounded-md">
    {{ errorMessage }}
  </div>

  <!-- Form for Adding Laboratory Test -->
  <form (ngSubmit)="addLabTest()" #labForm="ngForm">
    <div class="space-y-4">
      
      <!-- Test Name -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Test Name <span [class.text-red-500]="!newTest.name" [class.text-green-500]="newTest.name">*</span></label>
        <input [(ngModel)]="newTest.name" name="name" required class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter test name" />
      </div>

      <!-- Search Patient -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Search Patient</label>
        <input [(ngModel)]="patientSearchTerm" (input)="filterPatients()" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Search for patient..." />
      </div>

      <!-- Patient Dropdown -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Patient <span [class.text-red-500]="!newTest.patient" [class.text-green-500]="newTest.patient">*</span></label>
        <select [(ngModel)]="newTest.patient" name="patient" required class="w-full p-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select patient</option>
          <option *ngFor="let patient of filteredPatients" [value]="patient.id">
            {{ patient.first_name }} {{ patient.last_name }} ({{ patient.ghana_card_number }})
          </option>
        </select>
      </div>

      <!-- Search Doctor -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Search Doctor</label>
        <input [(ngModel)]="doctorSearchTerm" (input)="filterDoctors()" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Search for doctor..." />
      </div>

      <!-- Doctor Dropdown -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Doctor <span [class.text-red-500]="!newTest.doctor" [class.text-green-500]="newTest.doctor">*</span></label>
        <select [(ngModel)]="newTest.doctor" name="doctor" required class="w-full p-2 border border-gray-300 rounded-md">
          <option value="" disabled selected>Select doctor</option>
          <option *ngFor="let doctor of filteredDoctors" [value]="doctor.id">
            {{ doctor.first_name }} {{ doctor.last_name }}
          </option>
        </select>
      </div>

      <!-- Date -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Date <span [class.text-red-500]="!newTest.date" [class.text-green-500]="newTest.date">*</span></label>
        <input [(ngModel)]="newTest.date" name="date" type="date" required class="w-full p-2 border border-gray-300 rounded-md" />
      </div>

      <!-- Status -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Status <span [class.text-red-500]="!newTest.status" [class.text-green-500]="newTest.status">*</span></label>
        <select [(ngModel)]="newTest.status" name="status" required class="w-full p-2 border border-gray-300 rounded-md">
          <option value="Pending">Pending</option>
          <option value="Completed">Completed</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>

      <!-- Type -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Type</label>
        <input [(ngModel)]="newTest.type" name="type" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter test type" />
      </div>

      <!-- Submit Button -->
      <button type="submit" [disabled]="!labForm.form.valid || isLoading" [class.cursor-not-allowed]="!labForm.form.valid || isLoading" [class.bg-gray-400]="!labForm.form.valid" [class.bg-blue-600]="labForm.form.valid" class="text-white px-6 py-2 rounded-md mt-4 disabled:opacity-60">
        <span *ngIf="isLoading">
          <!-- SVG Spinner (loading indicator) -->
          <svg class="animate-spin h-5 w-5 text-white mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" fill="none"></circle>
            <path fill="currentColor" d="M10 2a8 8 0 000 16 8 8 0 000-16z"></path>
          </svg>
          Loading...
        </span>
        <span *ngIf="!isLoading">Submit</span>
      </button>
    </div>
  </form>
</div>
