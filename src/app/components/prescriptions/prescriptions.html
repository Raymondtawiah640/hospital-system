<div *ngIf="isLoggedIn" class="flex justify-center items-center min-h-screen bg-gray-100 p-4">
  <div class="container mx-auto p-6 bg-white shadow-lg rounded-lg w-full max-w-4xl">
    <h2 class="text-2xl font-bold text-center mb-4">Prescription Management</h2>

    <!-- Success and Error Messages -->
    <div *ngIf="successMessage" class="text-green-500 text-center mb-4">
      {{ successMessage }}
    </div>
    <div *ngIf="errorMessage" class="text-red-500 text-center mb-4">
      {{ errorMessage }}
    </div>

    <!-- Toggle between modes -->
    <div class="flex justify-center mb-6">
      <button (click)="prescriptionMode = 'test'" [class.active]="prescriptionMode === 'test'"
              class="px-4 py-2 mx-2 rounded-lg border-2 border-blue-500 text-blue-500 hover:bg-blue-500 hover:text-white transition-colors">
        Prescribe from Test Results
      </button>
      <button (click)="prescriptionMode = 'direct'" [class.active]="prescriptionMode === 'direct'"
              class="px-4 py-2 mx-2 rounded-lg border-2 border-green-500 text-green-500 hover:bg-green-500 hover:text-white transition-colors">
        Direct Prescription
      </button>
    </div>

    <!-- Direct Prescription Form -->
    <div *ngIf="prescriptionMode === 'direct'" class="mb-6">
      <h3 class="text-xl font-semibold mb-4">Direct Prescription</h3>

      <!-- Patient Search -->
      <div class="mb-4 flex justify-center">
        <div class="max-w-sm">
          <label class="block text-gray-700 mb-2 text-center">Search Patient</label>
          <div class="flex gap-2">
            <input type="text" [(ngModel)]="patientName" placeholder="Enter patient name"
                   class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <button (click)="searchPatient()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700">
              Search
            </button>
          </div>
        </div>
      </div>

      <!-- Patient Selection -->
      <div *ngIf="patients.length > 0" class="mb-4 flex justify-center">
        <div class="max-w-sm w-full">
          <label class="block text-gray-700 mb-2 text-center">Select Patient</label>
          <select [(ngModel)]="prescriptionData.patientId" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <option value="">Select a patient</option>
            <option *ngFor="let patient of patients" [value]="patient.id">
              {{ patient.first_name }} {{ patient.last_name }} (ID: {{ patient.id }}, Card: {{ patient.ghana_card_number }}, Phone: {{ patient.phone_number }})
            </option>
          </select>
        </div>
      </div>

      <!-- Medicine Prescription Form -->
      <div *ngIf="prescriptionData.patientId" class="mt-6">
        <h4 class="text-lg font-semibold mb-4">Prescribe Medicines</h4>

        <!-- Illness/Condition Field -->
        <div class="mb-4">
          <label class="block text-gray-700 mb-1">Illness/Condition</label>
          <input [(ngModel)]="prescriptionData.illness" type="text" placeholder="Enter illness or condition"
                 class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>

        <div *ngFor="let med of prescriptionData.medicines; let i = index" class="mb-4 p-4 border rounded">
          <div class="flex justify-between items-center mb-2">
            <h5 class="text-md font-semibold">Medicine {{ i + 1 }}</h5>
            <button *ngIf="prescriptionData.medicines.length > 1" (click)="removeMedicine(i)" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-700">Remove</button>
          </div>

          <label class="block text-gray-700 mb-1">Select Medicine</label>
          <select [(ngModel)]="med.medicine" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none mb-2">
            <option value="">Select medicine</option>
            <option *ngFor="let medicine of filteredMedicines" [value]="medicine.name">
              {{ medicine.name }} (Stock: {{ medicine.stock_quantity }})
            </option>
          </select>

          <label class="block text-gray-700 mb-1">Dosage</label>
          <input [(ngModel)]="med.dosage" type="text" placeholder="Enter dosage"
                 class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none mb-2">

          <label class="block text-gray-700 mb-1">Instructions</label>
          <textarea [(ngModel)]="med.instructions" rows="3" placeholder="Enter instructions"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
        </div>

        <div class="mb-4">
          <button (click)="addMedicine()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-700">Add Another Medicine</button>
        </div>

        <!-- Buttons -->
        <div class="text-center">
          <button (click)="prescribeMedicineDirect()"
                  [disabled]="!isFormValid"
                  class="bg-blue-900 text-white px-6 py-2 rounded-lg hover:bg-blue-700 mr-2">
            <span *ngIf="!isLoading">Prescribe Medicine</span>
            <span *ngIf="isLoading">Loading...</span>
          </button>
          <button (click)="cancelDirect()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-700">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Test-based Prescription View -->
    <div *ngIf="prescriptionMode === 'test'">
      <!-- Search Test Results -->
      <div class="mt-2 mb-6 flex justify-center">
        <div class="max-w-xs w-full">
          <input type="text" [(ngModel)]="searchTerm" placeholder="Search test results..." class="border p-2 rounded w-full shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500"/>
        </div>
      </div>

      <!-- Test Results Table -->
      <div *ngIf="!isLoading && filteredTestResults.length > 0" class="overflow-x-auto mt-2 mb-6">
        <table class="min-w-full table-auto border-collapse border border-gray-300 shadow-md">
          <thead>
            <tr class="bg-blue-600 text-white">
              <th class="px-6 py-3 text-left">Test Name</th>
              <th class="px-6 py-3 text-left">Patient</th>
              <th class="px-6 py-3 text-left">Doctor</th>
              <th class="px-6 py-3 text-left">Date</th>
              <th class="px-6 py-3 text-left">Status</th>
              <th class="px-6 py-3 text-left">Action</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let result of filteredTestResults">
              <tr class="bg-gray-50 hover:bg-gray-100">
                <td class="px-6 py-3">{{ result.name }}</td>
                <td class="px-6 py-3">{{ result.patient_first_name }} {{ result.patient_last_name }}</td>
                <td class="px-6 py-3">{{ result.doctor_first_name }} {{ result.doctor_last_name }}</td>
                <td class="px-6 py-3">{{ result.date }}</td>
                <td class="px-6 py-3">{{ result.status }}</td>
                <td class="px-6 py-3">
                  <button (click)="selectTest(result)" [disabled]="prescribedTests.has(result.id)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Prescribe</button>
                </td>
              </tr>
              <tr *ngIf="selectedTest === result">
                <td colspan="6" class="p-4 bg-gray-100">
                  <!-- Prescription Form -->
                  <!-- Illness/Condition Field for Test-based -->
                  <div class="mb-4">
                    <label class="block text-gray-700 mb-1">Illness/Condition <span class="text-red-500">*</span></label>
                    <input [(ngModel)]="prescriptionData.illness" type="text" placeholder="Enter illness or condition (required)"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                  </div>

                  <div *ngFor="let med of prescriptionData.medicines; let i = index" class="mb-4 p-4 border rounded">
                    <div class="flex justify-between items-center mb-2">
                      <h4 class="text-lg font-semibold">Medicine {{ i + 1 }}</h4>
                      <button *ngIf="prescriptionData.medicines.length > 1" (click)="removeMedicine(i)" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-700">Remove</button>
                    </div>

                    <label class="block text-gray-700">Select Medicine</label>
                    <select [(ngModel)]="med.medicine" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none mb-2">
                      <option value="">Select medicine</option>
                      <option *ngFor="let medicine of filteredMedicines" [value]="medicine.name">
                        {{ medicine.name }} (Stock: {{ medicine.stock_quantity }})
                      </option>
                    </select>

                    <label class="block text-gray-700">Dosage</label>
                    <input [(ngModel)]="med.dosage" type="text" placeholder="Enter dosage"
                      class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none mb-2">

                    <label class="block text-gray-700">Instructions</label>
                    <textarea [(ngModel)]="med.instructions" rows="3" placeholder="Enter instructions"
                      class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
                  </div>

                  <div class="mb-4">
                    <button (click)="addMedicine()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-700">Add Another Medicine</button>
                  </div>

                  <!-- Buttons -->
                  <div class="text-center">
                    <button (click)="prescribeMedicine()"
                            [disabled]="!isFormValid"
                            class="bg-blue-900 text-white px-6 py-2 rounded-lg hover:bg-blue-700 mr-2">
                      <span *ngIf="!isLoading">Prescribe Medicine</span>
                      <span *ngIf="isLoading">Loading...</span>
                    </button>
                    <button (click)="cancel()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-700">Cancel</button>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>

      <!-- No Results Found -->
      <div *ngIf="!isLoading && filteredTestResults.length === 0" class="mt-2 text-center text-gray-600 mb-6">
        No test results found.
      </div>
    </div>
  </div>
</div>

<div *ngIf="!isLoggedIn" class="flex justify-center items-center min-h-screen bg-gray-100">
  <div class="container text-center">
    <p>Please log in as a doctor to prescribe medicine.</p>
  </div>
</div>
