<div *ngIf="isLoggedIn" class="flex justify-center items-center min-h-screen bg-gray-100">
  <div class="container mx-auto p-6 bg-white shadow-lg rounded-lg w-full sm:w-4/5 lg:w-3/4">
    <h2 class="text-2xl font-bold text-center mb-4">Prescribe Medicine Based on Test Results</h2>

    <!-- Success and Error Messages -->
    <div *ngIf="successMessage" class="text-green-500 text-center mb-4">
      {{ successMessage }}
    </div>
    <div *ngIf="errorMessage" class="text-red-500 text-center mb-4">
      {{ errorMessage }}
    </div>


    <!-- Doctor View -->
    <div>
      <!-- Search Test Results -->
      <div class="mt-2 mb-6">
        <input type="text" [(ngModel)]="searchTerm" placeholder="Search test results..." class="border p-2 rounded w-full shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500"/>
      </div>

      <!-- Test Results Table -->
      <div *ngIf="!isLoading && filteredTestResults.length > 0" class="overflow-x-auto mt-2 mb-6">
        <table class="min-w-full table-auto border-collapse border border-gray-300 shadow-md">
          <thead>
            <tr class="bg-blue-600 text-white">
              <th class="px-6 py-3 text-left">Test Name</th>
              <th class="px-6 py-3 text-left">Patient</th>
              <th class="px-6 py-3 text-left">Doctor</th>
              <th class="px-6 py-3 text-left">Date</th>
              <th class="px-6 py-3 text-left">Status</th>
              <th class="px-6 py-3 text-left">Action</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let result of filteredTestResults">
              <tr class="bg-gray-50 hover:bg-gray-100">
                <td class="px-6 py-3">{{ result.name }}</td>
                <td class="px-6 py-3">{{ result.patient_first_name }} {{ result.patient_last_name }}</td>
                <td class="px-6 py-3">{{ result.doctor_first_name }} {{ result.doctor_last_name }}</td>
                <td class="px-6 py-3">{{ result.date }}</td>
                <td class="px-6 py-3">{{ result.status }}</td>
                <td class="px-6 py-3">
                  <button (click)="selectTest(result)" [disabled]="prescribedTests.has(result.id)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Prescribe</button>
                </td>
              </tr>
              <tr *ngIf="selectedTest === result">
                <td colspan="6" class="p-4 bg-gray-100">
                  <!-- Prescription Form -->
                  <div *ngFor="let med of prescriptionData.medicines; let i = index" class="mb-4 p-4 border rounded">
                    <div class="flex justify-between items-center mb-2">
                      <h4 class="text-lg font-semibold">Medicine {{ i + 1 }}</h4>
                      <button *ngIf="prescriptionData.medicines.length > 1" (click)="removeMedicine(i)" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-700">Remove</button>
                    </div>

                    <label class="block text-gray-700">Select Medicine</label>
                    <select [(ngModel)]="med.medicine" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none mb-2">
                      <option value="">Select medicine</option>
                      <option *ngFor="let medicine of filteredMedicines" [value]="medicine.name">
                        {{ medicine.name }} (Stock: {{ medicine.stock_quantity }})
                      </option>
                    </select>

                    <label class="block text-gray-700">Dosage</label>
                    <input [(ngModel)]="med.dosage" type="text" placeholder="Enter dosage"
                      class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none mb-2">

                    <label class="block text-gray-700">Instructions</label>
                    <textarea [(ngModel)]="med.instructions" rows="3" placeholder="Enter instructions"
                      class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
                  </div>

                  <div class="mb-4">
                    <button (click)="addMedicine()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-700">Add Another Medicine</button>
                  </div>

                  <!-- Buttons -->
                  <div class="text-center">
                    <button (click)="prescribeMedicine()"
                            [disabled]="!isFormValid"
                            class="bg-blue-900 text-white px-6 py-2 rounded-lg hover:bg-blue-700 mr-2">
                      <span *ngIf="!isLoading">Prescribe Medicine</span>
                      <span *ngIf="isLoading">Loading...</span>
                    </button>
                    <button (click)="cancel()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-700">Cancel</button>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>

      <!-- No Results Found -->
      <div *ngIf="!isLoading && filteredTestResults.length === 0" class="mt-2 text-center text-gray-600 mb-6">
        No test results found.
      </div>
    </div>


  </div>
</div>

<div *ngIf="!isLoggedIn" class="flex justify-center items-center min-h-screen bg-gray-100">
  <div class="container text-center">
    <p>Please log in as a doctor to prescribe medicine.</p>
  </div>
</div>
